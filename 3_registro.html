<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Help Desk | Registro (Wizard)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
</head>
<body>
 <div class="app-shell d-flex">
    <!-- Sidebar -->
    <aside class="sidebar d-flex flex-column p-3" aria-label="Barra lateral">
      <h1 class="h5 fw-bold mb-4">Help Desk</h1>

      <nav class="nav flex-column" aria-label="Navegación principal">
        <a class="nav-link" href="./2_home.html">
          <i class="bi bi-house" aria-hidden="true"></i><span class="nav-label"> Inicio</span>
        </a>
        <a class="nav-link active" href="./3_registro.html">
          <i class="bi bi-plus-circle" aria-hidden="true"></i><span class="nav-label"> Registrar</span>
        </a>
        <a class="nav-link" href="./4_actividades_admin.html">
          <i class="bi bi-list-task" aria-hidden="true"></i><span class="nav-label"> Actividades</span>
        </a>

        <div class="nav-item">
          <button
            class="nav-link d-flex align-items-center w-100 text-start bg-transparent border-0 px-0"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#perfilMenu"
            aria-expanded="false"
            aria-controls="perfilMenu"
          >
            <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
            <span class="nav-label"> Mi Perfil</span>
            <i class="bi bi-caret-down ms-auto" aria-hidden="true"></i>
          </button>
          <div id="perfilMenu" class="collapse ps-3 mt-1">
            <a class="d-block small text-light" href="./7_perfil_usuario.html">
              <i class="bi bi-person" aria-hidden="true"></i><span class="nav-label"> Datos personales</span>
            </a>
            <a class="d-block small text-light mt-1" href="./5_kpis_user.html">
              <i class="bi bi-activity" aria-hidden="true"></i><span class="nav-label"> Mis KPIs</span>
            </a>
          </div>
        </div>

        <hr class="border-light my-3" />

        <a class="nav-link" href="./8_configuraciones.html">
          <i class="bi bi-gear" aria-hidden="true"></i><span class="nav-label"> Configuración</span>
        </a>
        <a class="nav-link" href="./index.html">
          <i class="bi bi-box-arrow-right" aria-hidden="true"></i><span class="nav-label"> Cerrar sesión</span>
        </a>
      </nav>
    </aside>

    <div class="app-main flex-grow-1 d-flex flex-column min-vh-100">
      <nav class="navbar bg-white px-4" aria-label="Barra superior">
        <span class="navbar-brand h1 mb-0">Registrar Actividad</span>
        <div class="ms-auto small text-muted">
          Guardado automático <span id="autosaveState" class="text-success" aria-live="polite">●</span>
        </div>
      </nav>

      <!-- Tabs: Registro general vs Renovaciones -->
      <div class="bg-white border-bottom">
        <div class="container-fluid px-4 py-3">
          <ul class="nav nav-pills gap-2" id="modeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-general"
                data-bs-toggle="pill" data-bs-target="#pane-general" type="button" role="tab"
                aria-controls="pane-general" aria-selected="true">
                <i class="bi bi-list-task me-1" aria-hidden="true"></i> Registro general
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-renov"
                data-bs-toggle="pill" data-bs-target="#pane-renov" type="button" role="tab"
                aria-controls="pane-renov" aria-selected="false">
                <i class="bi bi-shield-check me-1" aria-hidden="true"></i> Renovaciones
              </button>
            </li>
          </ul>
        </div>
      </div>

      <main class="container-fluid py-4 tab-content" id="wizardModes">
        <!-- ===================== REGISTRO GENERAL (wizard existente) ===================== -->
        <div class="tab-pane fade show active" id="pane-general" role="tabpanel" aria-labelledby="tab-general">
          <!-- STEPPER -->
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <div class="stepper" id="stepper" aria-label="Pasos del registro">
                <div class="step active" data-step="1"><div class="dot">1</div><div class="label">Recepción</div></div>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <div class="step" data-step="2"><div class="dot">2</div><div class="label">Solicitud</div></div>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <div class="step" data-step="3"><div class="dot">3</div><div class="label">Área & Respuesta</div></div>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <div class="step" data-step="4"><div class="dot">4</div><div class="label">Envío a Agente</div></div>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <div class="step" data-step="5"><div class="dot">5</div><div class="label">Seguimiento</div></div>
                <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <div class="step" data-step="6"><div class="dot">6</div><div class="label">Resumen</div></div>
              </div>
            </div>
          </div>

          <!-- FORM SECTIONS (wizard) -->
          <form id="wizardForm" novalidate>
            <!-- Paso 1: Recepción -->
            <section class="card border-0 shadow-sm card-section mb-3" data-step="1">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-inbox me-2" aria-hidden="true"></i>Recepción
                </h2>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="f-colaborador">Colaborador</label>
                    <input id="f-colaborador" class="form-control" name="colaborador" placeholder="Tu nombre" required autocomplete="name">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-fecha">Fecha</label>
                    <input id="f-fecha" type="date" class="form-control" name="fecha" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-hrec">Hora de Recepción</label>
                    <input id="f-hrec" type="time" class="form-control" name="hora_recepcion" required>
                  </div>
                </div>
              </div>
            </section>

            <!-- Paso 2: Solicitud -->
            <section class="card border-0 shadow-sm card-section mb-3 d-none" data-step="2">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-journal-text me-2" aria-hidden="true"></i>Solicitud
                </h2>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="f-agente">Agente Clave</label>
                    <input id="f-agente" class="form-control" name="agente_clave" placeholder="88200" inputmode="numeric" autocomplete="off">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-forma">Forma de Solicitud</label>
                    <select id="f-forma" class="form-select" name="forma_solicitud" required>
                      <option value="" selected disabled>Selecciona</option>
                      <option value="Email">Email</option>
                      <option value="Teléfono">Teléfono</option>
                      <option value="WhatsApp">WhatsApp</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-tipo">Tipo de Solicitud</label>
                    <select id="f-tipo" class="form-select" name="tipo_solicitud" required>
                      <option value="" selected disabled>Selecciona</option>
                      <option value="Renovación">Renovación</option>
                      <option value="Cancelación">Cancelación</option>
                      <option value="Aplicación de Primas">Aplicación de Primas</option>
                    </select>
                  </div>
                </div>
              </div>
            </section>

            <!-- Paso 3: Área y tiempos de envío/respuesta -->
            <section class="card border-0 shadow-sm card-section mb-3 d-none" data-step="3">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-send-check me-2" aria-hidden="true"></i>Área & Respuesta
                </h2>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="f-area-env">Enviado al Área</label>
                    <select id="f-area-env" class="form-select" name="enviado_area">
                      <option value="" selected disabled>Selecciona</option>
                      <option value="AOF">AOF</option>
                      <option value="Caja Metepec">Caja Metepec</option>
                      <option value="Control de Calidad">Control de Calidad</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Fecha/Hora envío al Área</label>
                    <div class="input-group">
                      <input type="date" class="form-control" name="fecha_envio_area">
                      <input type="time" class="form-control" name="hora_envio_area">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Fecha/Hora respuesta del Área</label>
                    <div class="input-group">
                      <input type="date" class="form-control" name="fecha_resp_area">
                      <input type="time" class="form-control" name="hora_resp_area">
                    </div>
                  </div>
                  <div class="col-12 mt-2">
                    <div class="d-flex flex-wrap gap-2">
                      <span id="chip_t_envio_area" class="badge text-bg-light border" hidden>
                        ⏱️ Tiempo para enviar al Área: <strong><span data-val="t_envio">—</span></strong>
                      </span>
                      <span id="chip_t_resp_area" class="badge text-bg-light border" hidden>
                        📨 Tiempo de respuesta del Área: <strong><span data-val="t_resp">—</span></strong>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Paso 4: Envío al agente -->
            <section class="card border-0 shadow-sm card-section mb-3 d-none" data-step="4">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-share me-2" aria-hidden="true"></i>Envío al Agente
                </h2>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Fecha/Hora envío al Agente</label>
                    <div class="input-group">
                      <input type="date" class="form-control" name="fecha_envio_agente">
                      <input type="time" class="form-control" name="hora_envio_agente">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label" for="f-asunto">Asunto en el correo</label>
                    <input id="f-asunto" class="form-control" name="asunto_correo" placeholder="Ej. Renovación póliza flotilla Q3">
                  </div>
                </div>
              </div>
            </section>

            <!-- Paso 5: Seguimiento -->
            <section class="card border-0 shadow-sm card-section mb-3 d-none" data-step="5">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-flag me-2" aria-hidden="true"></i>Seguimiento
                </h2>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="f-estatus">Estatus</label>
                    <select id="f-estatus" class="form-select" name="estatus">
                      <option value="Pendiente">Pendiente</option>
                      <option value="En curso">En curso</option>
                      <option value="Finalizado">Finalizado</option>
                      <option value="Bloqueado">Bloqueado</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-fseg">Fecha de Seguimiento</label>
                    <input id="f-fseg" type="date" class="form-control" name="fecha_seguimiento">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label" for="f-com">Comentarios</label>
                    <input id="f-com" class="form-control" name="comentarios" placeholder="Notas adicionales...">
                  </div>
                </div>
              </div>
            </section>

            <!-- Paso 6: Resumen -->
            <section class="card border-0 shadow-sm card-section mb-3 d-none" data-step="6">
              <div class="card-body">
                <h2 class="h6 text-secondary fw-semibold mb-3">
                  <i class="bi bi-clipboard-check me-2" aria-hidden="true"></i>Revisión final
                </h2>
                <div id="resume" class="row g-3 small"><!-- JS --></div>
              </div>
            </section>

            <!-- Footer de navegación -->
            <div class="sticky-footer d-flex justify-content-between align-items-center">
              <button type="button" class="btn btn-outline-secondary" id="btnPrev" aria-label="Ir al paso anterior">
                <i class="bi bi-arrow-left-short me-1" aria-hidden="true"></i>Atrás
              </button>
              <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-primary" id="btnSave">
                  <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i>Guardar borrador
                </button>
                <button type="button" class="btn btn-brand" id="btnNext">
                  Siguiente <i class="bi bi-arrow-right-short ms-1" aria-hidden="true"></i>
                </button>
                <button type="submit" class="btn btn-success d-none" id="btnSubmit">
                  <i class="bi bi-send-check me-1" aria-hidden="true"></i>Enviar
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- ===================== RENOVACIONES (formulario específico) ===================== -->
        <div class="tab-pane fade" id="pane-renov" role="tabpanel" aria-labelledby="tab-renov">
          <form id="renewForm" class="card border-0 shadow-sm p-4" novalidate>
            <h2 class="h6 text-secondary fw-semibold mb-3">
              <i class="bi bi-shield-check me-2" aria-hidden="true"></i>Registro de Renovación
            </h2>
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="form-label" for="ren_fecha">Fecha de Renovación</label>
                <input type="datetime-local" class="form-control" id="ren_fecha" name="ren_fecha" readonly>
                <div class="form-text">Se establece automáticamente al capturar póliza.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="ren_poliza_anterior">Póliza anterior</label>
                <input class="form-control" id="ren_poliza_anterior" name="ren_poliza_anterior" placeholder="Q-PLZ-2024-7781" required>
              </div>
              <div class="col-md-4">
                <label class="form-label" for="ren_poliza_nueva">Póliza renovada</label>
                <input class="form-control" id="ren_poliza_nueva" name="ren_poliza_nueva" placeholder="Q-PLZ-2025-8892" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="ren_coment">Comentarios</label>
              <textarea class="form-control" id="ren_coment" name="ren_coment" rows="2" placeholder="Notas de renovación..."></textarea>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-outline-primary" id="renSave">
                <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i>Guardar borrador
              </button>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check2-circle me-1" aria-hidden="true"></i>Registrar renovación
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous" defer></script>

  <!-- Wizard + lógica de página -->
  <script data-init>
  // ====== WIZARD (Registro general) ======
  const form = document.getElementById('wizardForm');
  const sections = form ? [...document.querySelectorAll('#pane-general section[data-step]')] : [];
  const steps = form ? [...document.querySelectorAll('#pane-general .stepper .step')] : [];
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnSubmit = document.getElementById('btnSubmit');
  const btnSave = document.getElementById('btnSave');
  const resume = document.getElementById('resume');
  let current = 1;

  function lastStep(){ return sections.length ? +sections.at(-1).dataset.step : 1; }

  function focusFirstInput(stepEl){
    const el = stepEl && stepEl.querySelector('input, select, textarea, button');
    if(el) el.focus({preventScroll:true});
  }

  function showStep(n){
    if(!form) return;
    const last = lastStep();
    current = Math.max(1, Math.min(n, last));
    sections.forEach(s => s.classList.toggle('d-none', +s.dataset.step !== current));
    steps.forEach(s => {
      s.classList.toggle('active', +s.dataset.step === current);
      s.classList.toggle('done', +s.dataset.step < current);
    });
    btnPrev.disabled = (current === 1);
    btnNext.classList.toggle('d-none', current === last);
    btnSubmit.classList.toggle('d-none', current !== last);
    if(current === last){ buildResume(); }
    focusFirstInput(sections.find(s => +s.dataset.step === current));
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function buildResume(){
    const data = Object.fromEntries(new FormData(form));
    const pretty = {
      'colaborador':'Colaborador','fecha':'Fecha','hora_recepcion':'Hora de recepción',
      'agente_clave':'Agente clave','forma_solicitud':'Forma de solicitud','tipo_solicitud':'Tipo de solicitud',
      'enviado_area':'Enviado al área','fecha_envio_area':'Fecha envío área','hora_envio_area':'Hora envío área',
      'fecha_resp_area':'Fecha respuesta área','hora_resp_area':'Hora respuesta área',
      'fecha_envio_agente':'Fecha envío agente','hora_envio_agente':'Hora envío agente',
      'estatus':'Estatus','fecha_seguimiento':'Fecha seguimiento','comentarios':'Comentarios'
    };
    resume.innerHTML = Object.entries(pretty).map(([key,label])=>{
      const val = (data[key] ?? '') || '—';
      return `<div class="col-md-4"><div class="border rounded-3 p-3 bg-light mb-2"><div class="text-muted">${label}</div><div class="fw-semibold">${val}</div></div></div>`;
    }).join('');
  }

  function validateStep(){
    let ok = true;
    const visible = sections.find(s => +s.dataset.step === current);
    visible && [...visible.querySelectorAll('[required]')].forEach(inp => {
      if(!inp.value){ inp.classList.add('is-invalid'); ok = false; }
      else inp.classList.remove('is-invalid');
      inp.addEventListener('input', ()=> inp.classList.remove('is-invalid'), { once:true });
    });
    return ok;
  }

  // Debounce util
  function debounce(fn, ms=400){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
  function saveDraft(showToast){
    const data = Object.fromEntries(new FormData(form));
    localStorage.setItem('helpdesk_draft', JSON.stringify({ current, data, when: Date.now() }));
    if(showToast && window.bootstrap){
      const t = document.createElement('div');
      t.className = 'toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3';
      t.role = 'alert';
      t.innerHTML = `<div class="d-flex"><div class="toast-body">Borrador guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(t);
      const toast = new bootstrap.Toast(t); toast.show();
      t.addEventListener('hidden.bs.toast',()=>t.remove());
    }
  }
  const saveDraftDebounced = debounce(()=>saveDraft(false), 500);

  // Cálculo de tiempos (paso 3)
  function parseDT(d, t){ if(!d || !t) return null; return new Date(`${d}T${t}`); }
  function humanDiff(ms){
    if(!Number.isFinite(ms)) return '—';
    const min = Math.round(ms/60000);
    const h = Math.floor(min/60), m = min%60;
    if(h <= 0) return `${m} min`;
    if(m === 0) return `${h} h`;
    return `${h} h ${m} min`;
  }
  function computeDurations(){
    const dRec = form.fecha?.value, tRec = form.hora_recepcion?.value;
    const dEnvA = form.fecha_envio_area?.value, tEnvA = form.hora_envio_area?.value;
    const dResp = form.fecha_resp_area?.value, tResp = form.hora_resp_area?.value;

    const dtRec = parseDT(dRec, tRec);
    const dtEnvA = parseDT(dEnvA, tEnvA);
    const dtResp = parseDT(dResp, tResp);

    const chipEnv = document.getElementById('chip_t_envio_area');
    const chipEnvVal = chipEnv?.querySelector('[data-val="t_envio"]');
    if (dtRec && dtEnvA && chipEnv && chipEnvVal){
      chipEnv.hidden = false;
      chipEnvVal.textContent = humanDiff(dtEnvA - dtRec);
    } else if (chipEnv){ chipEnv.hidden = true; }

    const chipResp = document.getElementById('chip_t_resp_area');
    const chipRespVal = chipResp?.querySelector('[data-val="t_resp"]');
    if (dtEnvA && dtResp && chipResp && chipRespVal){
      chipResp.hidden = false;
      chipRespVal.textContent = humanDiff(dtResp - dtEnvA);
    } else if (chipResp){ chipResp.hidden = true; }
  }

  if(form){
    btnNext.addEventListener('click', () => {
      if(validateStep()){
        current = Math.min(current+1, lastStep());
        showStep(current);
        saveDraft();
      }
    });
    btnPrev.addEventListener('click', () => {
      current = Math.max(1, current-1);
      showStep(current);
    });
    btnSave.addEventListener('click', () => saveDraft(true));

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Registro enviado (mock). Aquí haríamos POST a /activities');
      localStorage.removeItem('helpdesk_draft');
    });

    form.addEventListener('input', saveDraftDebounced);

    form.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        const isTextArea = e.target && e.target.tagName === 'TEXTAREA';
        if(!isTextArea){ e.preventDefault(); btnNext.click(); }
      } else if(e.key === 'Enter' && e.shiftKey){
        e.preventDefault(); btnPrev.click();
      }
    });

    ['fecha','hora_recepcion','fecha_envio_area','hora_envio_area','fecha_resp_area','hora_resp_area']
      .forEach(name => { if(form.elements[name]) form.elements[name].addEventListener('input', computeDurations); });

    (function(){
      const draft = JSON.parse(localStorage.getItem('helpdesk_draft')||'null');
      if(draft){
        current = draft.current || 1;
        for(const [k,v] of Object.entries(draft.data||{})){
          const el = form.elements[k]; if(el) el.value = v;
        }
      }
      showStep(current);
      computeDurations();
    })();
  }

  // ====== RENOVACIONES (form específico) ======
  const renForm = document.getElementById('renewForm');
  const renFecha = document.getElementById('ren_fecha');
  const renPolizaNueva = document.getElementById('ren_poliza_nueva');
  const renPolizaAnterior = document.getElementById('ren_poliza_anterior');
  const renSaveBtn = document.getElementById('renSave');

  function setNowIfEmpty(){
    if(!renFecha || renFecha.value) return;
    // si ya está seteada, no sobreescribir
  }

  if(renForm){
    // Set automático al empezar a capturar (solo si está vacío)
    function maybeSetNow(){
      if(!renFecha.value){
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        renFecha.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      }
    }
    renPolizaNueva.addEventListener('input', maybeSetNow);
    renPolizaAnterior.addEventListener('input', maybeSetNow);

    renSaveBtn.addEventListener('click', ()=>{
      const data = Object.fromEntries(new FormData(renForm));
      localStorage.setItem('helpdesk_renov_draft', JSON.stringify(data));
      if(window.bootstrap){
        const t=document.createElement('div');
        t.className='toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3';
        t.role='alert';
        t.innerHTML=`<div class="d-flex"><div class="toast-body">Borrador de renovación guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.body.appendChild(t);
        const toast=new bootstrap.Toast(t); toast.show();
        t.addEventListener('hidden.bs.toast',()=>t.remove());
      }
    });

    renForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      alert('Renovación registrada (mock). Aquí haríamos POST a /renewals');
      localStorage.removeItem('helpdesk_renov_draft');
      renForm.reset(); if(renFecha) renFecha.value = '';
    });

    (function(){
      const d = JSON.parse(localStorage.getItem('helpdesk_renov_draft')||'null');
      if(d){ Object.entries(d).forEach(([k,v])=>{ const el = renForm.elements[k]; if(el) el.value = v; }); }
    })();
  }
  </script>

  <!-- Router SPA -->
  <script>
  (function(){
    const supportsVT = 'startViewTransition' in document;

    async function loadPartial(url){
      const res = await fetch(url, {credentials:'same-origin'});
      const html = await res.text();
      const doc  = new DOMParser().parseFromString(html, 'text/html');
      const newMain = doc.querySelector('.app-main');
      const newTitle= doc.querySelector('title')?.textContent || document.title;
      return { newMain, newTitle, doc };
    }

    function setActiveLink(url){
      const links = document.querySelectorAll('.sidebar a[data-spa]');
      links.forEach(a => a.classList.toggle('active', a.href === url));
    }

    async function navigate(url, push=true){
      const currentMain = document.querySelector('.app-main');
      const doSwap = async () => {
        const { newMain, newTitle, doc } = await loadPartial(url);
        if(!newMain) { location.href = url; return; } // fallback total

        currentMain.classList.add('is-leaving');
        await new Promise(r=>setTimeout(r, 120));

        currentMain.replaceWith(newMain);
        document.title = newTitle;

        newMain.classList.add('is-entering');
        requestAnimationFrame(()=> newMain.classList.add('app-main--ready'));
        setTimeout(()=> newMain.classList.remove('is-entering','app-main--ready'), 180);

        if(window.bootstrap){
          document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>new bootstrap.Tooltip(el));
        }

        setActiveLink(new URL(url, location.href).href);

        // Re-init scripts marcados como data-init
        doc.querySelectorAll('script[data-init]').forEach(s=>{
          try { eval(s.textContent); } catch(e){ console.error(e); }
        });
      };

      if(supportsVT){ document.startViewTransition(doSwap); }
      else { await doSwap(); }

      if(push) history.pushState({ spa:true }, '', url);
    }

    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-spa]');
      if(!a) return;
      const url = a.getAttribute('href');
      if(!url || url.startsWith('http') || url.startsWith('#')) return;
      e.preventDefault();
      navigate(url, true);
    });

    window.addEventListener('popstate', (e)=>{
      if(e.state && e.state.spa){ navigate(location.href, false); }
      else location.reload();
    });
  })();
  </script>
</body>
</html>
