<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Help Desk | Registro (Wizard)</title>
    <!-- CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/css/theme.css" rel="stylesheet" />
  </head>
  <body>
    <div class="app-shell d-flex">
      <!-- Sidebar -->
      <aside class="sidebar d-flex flex-column p-3" aria-label="Barra lateral">
        <h1 class="h5 fw-bold mb-4">Help Desk</h1>
        <nav class="nav flex-column" aria-label="Navegaci√≥n principal">
          <a class="nav-link active" href="registro.html">
            <i class="bi bi-plus-circle" aria-hidden="true"></i>
            <span class="nav-label"> Registrar actividad</span>
          </a>
          <a class="nav-link" href="actividades.html">
            <i class="bi bi-list-task" aria-hidden="true"></i>
            <span class="nav-label"> Actividades colaboradores</span>
          </a>
          <a class="nav-link" href="kpis.html">
            <i class="bi bi-activity" aria-hidden="true"></i>
            <span class="nav-label"> Mis KPIs</span>
          </a>
          <a class="nav-link" href="kpis_admin.html">
            <i class="bi bi-bar-chart-steps" aria-hidden="true"></i>
            <span class="nav-label"> KPIs Admin</span>
          </a>
          <hr class="border-light my-3" />
          <div class="nav-item">
            <button
              class="nav-link d-flex align-items-center w-100 text-start bg-transparent border-0 px-0"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#perfilMenu"
              aria-expanded="false"
              aria-controls="perfilMenu"
            >
              <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
              <span class="nav-label"> Mi Perfil</span>
              <i class="bi bi-caret-down ms-auto" aria-hidden="true"></i>
            </button>
            <div id="perfilMenu" class="collapse ps-3 mt-1">
              <a class="d-block small text-light" href="perfil.html">
                <i class="bi bi-person" aria-hidden="true"></i>
                <span class="nav-label"> Datos personales</span>
              </a>
              <a
                class="d-block small text-light mt-1"
                href="configuraciones.html"
              >
                <i class="bi bi-gear" aria-hidden="true"></i>
                <span class="nav-label"> Preferencias</span>
              </a>
            </div>
          </div>
          <hr class="border-light my-3" />
          <a class="nav-link" href="index.html">
            <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
            <span class="nav-label"> Cerrar sesi√≥n</span>
          </a>
        </nav>
      </aside>

      <div class="app-main flex-grow-1 d-flex flex-column min-vh-100">
        <nav class="navbar bg-white px-4" aria-label="Barra superior">
          <span class="navbar-brand h1 mb-0">Registrar Actividad</span>
          <div class="ms-auto small text-muted">
            Guardado autom√°tico
            <span id="autosaveState" class="text-success" aria-live="polite"
              >‚óè</span
            >
          </div>
        </nav>

        <!-- Tabs: Registro general vs Renovaciones -->
        <div class="bg-white border-bottom">
          <div class="container-fluid px-4 py-3">
            <ul class="nav nav-pills gap-2" id="modeTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="tab-general"
                  data-bs-toggle="pill"
                  data-bs-target="#pane-general"
                  type="button"
                  role="tab"
                  aria-controls="pane-general"
                  aria-selected="true"
                >
                  <i class="bi bi-list-task me-1" aria-hidden="true"></i>
                  Registro general
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="tab-renov"
                  data-bs-toggle="pill"
                  data-bs-target="#pane-renov"
                  type="button"
                  role="tab"
                  aria-controls="pane-renov"
                  aria-selected="false"
                >
                  <i class="bi bi-shield-check me-1" aria-hidden="true"></i>
                  Renovaciones
                </button>
              </li>
            </ul>
          </div>
        </div>

        <main class="container-fluid py-4 tab-content" id="wizardModes">
          <!-- ===================== REGISTRO GENERAL (wizard existente) ===================== -->
          <div
            class="tab-pane fade show active"
            id="pane-general"
            role="tabpanel"
            aria-labelledby="tab-general"
          >
            <!-- STEPPER -->
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body">
                <div
                  class="stepper"
                  id="stepper"
                  aria-label="Pasos del registro"
                >
                  <div class="step active" data-step="1">
                    <div class="dot">1</div>
                    <div class="label">
                      Recepci√≥n, Solicitud y Env√≠o al √°rea
                    </div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="2">
                    <div class="dot">2</div>
                    <div class="label">Seguimiento</div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="3">
                    <div class="dot">3</div>
                    <div class="label">Env√≠o a Agente</div>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <div class="step" data-step="4">
                    <div class="dot">4</div>
                    <div class="label">Resumen</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FORM SECTIONS (wizard) -->
            <form id="wizardForm" novalidate>
              <!-- Paso 1: Recepci√≥n -->
              <section
                class="card border-0 shadow-sm card-section mb-3"
                data-step="1"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-inbox me-2" aria-hidden="true"></i>Recepci√≥n
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-colaborador"
                        >Colaborador</label
                      >
                      <input
                        id="f-colaborador"
                        class="form-control"
                        name="colaborador"
                        placeholder="Tu nombre"
                        required
                        autocomplete="name"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-fecha">Fecha</label>
                      <input
                        id="f-fecha"
                        type="date"
                        class="form-control"
                        name="fecha"
                        required
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-hrec"
                        >Hora de Recepci√≥n</label
                      >
                      <input
                        id="f-hrec"
                        type="time"
                        class="form-control"
                        name="hora_recepcion"
                        required
                      />
                    </div>
                  </div>
                </div>

                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-journal-text me-2" aria-hidden="true"></i
                    >Solicitud
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-agente"
                        >Agente Clave</label
                      >
                      <input
                        id="f-agente"
                        class="form-control"
                        name="agente_clave"
                        inputmode="numeric"
                        autocomplete="on"
                        required
                        minlength="5"
                        maxlength="5"
                        pattern="\d{5}"
                      />
                      <div class="invalid-feedback" id="agente-error">
                        La clave debe tener 5 d√≠gitos.
                      </div>
                      <div
                        id="agente-info"
                        class="form-text text-muted small"
                      ></div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-forma"
                        >Forma de Solicitud</label
                      >
                      <select
                        id="f-forma"
                        class="form-select"
                        name="forma_solicitud"
                        required
                      >
                        <option value="" selected disabled>Selecciona</option>
                        <option value="Email">Email</option>
                        <option value="Tel√©fono">Tel√©fono</option>
                        <option value="WhatsApp">WhatsApp</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-tipo"
                        >Tipo de Solicitud</label
                      >
                      <select
                        id="f-tipo"
                        class="form-select"
                        name="tipo_solicitud"
                        required
                      >
                        <option value="" selected disabled>Selecciona</option>
                        <option value="Renovaci√≥n">Renovaci√≥n</option>
                        <option value="Cancelaci√≥n">Cancelaci√≥n</option>
                        <option value="Aplicaci√≥n de Primas">
                          Aplicaci√≥n de Primas
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Paso 3: √Årea y tiempos de env√≠o/respuesta -->
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-send-check me-2" aria-hidden="true"></i>√Årea
                    & Respuesta
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-area-env"
                        >Enviado al √Årea</label
                      >
                      <select
                        id="f-area-env"
                        class="form-select"
                        name="enviado_area"
                      >
                        <option value="" selected disabled>Selecciona</option>
                        <option value="AOF">AOF</option>
                        <option value="Caja Metepec">Caja Metepec</option>
                        <option value="Control de Calidad">
                          Control de Calidad
                        </option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Fecha/Hora env√≠o al √Årea</label>
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_envio_area"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_envio_area"
                        />
                      </div>
                      <div
                        id="error-hora-envio-area"
                        class="form-text text-danger small"
                      ></div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label"
                        >Fecha/Hora respuesta del √Årea</label
                      >
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_resp_area"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_resp_area"
                        />
                      </div>
                    </div>

                    <div class="col-12 mt-2">
                      <div class="d-flex flex-wrap gap-2">
                        <span
                          id="chip_t_envio_area"
                          class="badge text-bg-light border"
                          hidden
                        >
                          ‚è±Ô∏è Tiempo para enviar al √Årea:
                          <strong><span data-val="t_envio">‚Äî</span></strong>
                        </span>
                        <span
                          id="chip_t_resp_area"
                          class="badge text-bg-light border"
                          hidden
                        >
                          üì® Tiempo de respuesta del √Årea:
                          <strong><span data-val="t_resp">‚Äî</span></strong>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 3: Seguimiento -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="2"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-flag me-2" aria-hidden="true"></i
                    >Seguimiento
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="f-estatus">Estatus</label>
                      <select id="f-estatus" class="form-select" name="estatus">
                        <option value="En curso">En curso</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Enviado a √°rea">Enviado a √°rea</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-fseg"
                        >Fecha de Seguimiento</label
                      >
                      <input
                        id="f-fseg"
                        type="date"
                        class="form-control"
                        name="fecha_seguimiento"
                      />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="f-com">Comentarios</label>
                      <input
                        id="f-com"
                        class="form-control"
                        name="comentarios"
                        placeholder="Notas adicionales..."
                      />
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 2: Env√≠o al agente -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="3"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-share me-2" aria-hidden="true"></i>Env√≠o al
                    Agente
                  </h2>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label"
                        >Fecha/Hora env√≠o al Agente</label
                      >
                      <div class="input-group">
                        <input
                          type="date"
                          class="form-control"
                          name="fecha_envio_agente"
                        />
                        <input
                          type="time"
                          class="form-control"
                          name="hora_envio_agente"
                          min="08:30"
                          max="18:30"
                          step="60"
                        />
                      </div>
                      <div
                        id="error-hora-envio-agente"
                        class="form-text text-danger small"
                      ></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="f-asunto"
                        >Asunto en el correo</label
                      >
                      <input
                        id="f-asunto"
                        class="form-control"
                        name="asunto_correo"
                        placeholder="Ej. Renovaci√≥n p√≥liza flotilla Q3"
                      />
                    </div>
                  </div>
                </div>
              </section>

              <!-- Paso 4: Resumen -->
              <section
                class="card border-0 shadow-sm card-section mb-3 d-none"
                data-step="4"
              >
                <div class="card-body">
                  <h2 class="h6 text-secondary fw-semibold mb-3">
                    <i class="bi bi-clipboard-check me-2" aria-hidden="true"></i
                    >Revisi√≥n final
                  </h2>
                  <div id="resume" class="row g-3 small"><!-- JS --></div>
                </div>
              </section>

              <!-- Footer de navegaci√≥n -->
              <div
                class="sticky-footer d-flex justify-content-between align-items-center"
              >
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="btnPrev"
                  aria-label="Ir al paso anterior"
                >
                  <i class="bi bi-arrow-left-short me-1" aria-hidden="true"></i
                  >Atr√°s
                </button>
                <div class="d-flex align-items-center gap-2">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    id="btnSave"
                  >
                    <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i
                    >Guardar borrador
                  </button>
                  <button type="button" class="btn btn-brand" id="btnNext">
                    Siguiente
                    <i
                      class="bi bi-arrow-right-short ms-1"
                      aria-hidden="true"
                    ></i>
                  </button>
                  <button
                    type="submit"
                    class="btn btn-success d-none"
                    id="btnSubmit"
                  >
                    <i class="bi bi-send-check me-1" aria-hidden="true"></i
                    >Enviar
                  </button>
                </div>
              </div>
            </form>
          </div>

          <!-- ===================== RENOVACIONES (formulario espec√≠fico) ===================== -->
          <div
            class="tab-pane fade"
            id="pane-renov"
            role="tabpanel"
            aria-labelledby="tab-renov"
          >
            <form id="renewForm" class="card border-0 shadow-sm p-4" novalidate>
              <h2 class="h6 text-secondary fw-semibold mb-3">
                <i class="bi bi-shield-check me-2" aria-hidden="true"></i
                >Registro de Renovaci√≥n
              </h2>
              <div class="row g-3 mb-3">
                <div class="mb-3">
                  <label class="form-label" for="f-colaborador"
                    >Colaborador</label
                  >
                  <input
                    id="f-colaborador"
                    class="form-control"
                    name="colaborador"
                    placeholder="Tu nombre"
                    required
                    autocomplete="name"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_fecha"
                    >Fecha de Renovaci√≥n</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="ren_fecha"
                    name="ren_fecha"
                    readonly
                  />
                  <div class="form-text">
                    Se establece autom√°ticamente al capturar p√≥liza.
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_poliza_anterior"
                    >P√≥liza anterior</label
                  >
                  <input
                    class="form-control"
                    id="ren_poliza_anterior"
                    name="ren_poliza_anterior"
                    placeholder="Q-PLZ-2024-7781"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="ren_poliza_nueva"
                    >P√≥liza renovada</label
                  >
                  <input
                    class="form-control"
                    id="ren_poliza_nueva"
                    name="ren_poliza_nueva"
                    placeholder="Q-PLZ-2025-8892"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="ren_coment">Comentarios</label>
                <textarea
                  class="form-control"
                  id="ren_coment"
                  name="ren_coment"
                  rows="2"
                  placeholder="Notas de renovaci√≥n..."
                ></textarea>
              </div>
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="renSave"
                >
                  <i class="bi bi-cloud-arrow-up me-1" aria-hidden="true"></i
                  >Guardar borrador
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-check2-circle me-1" aria-hidden="true"></i
                  >Registrar renovaci√≥n
                </button>
              </div>
            </form>
          </div>
        </main>
      </div>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
      defer
    ></script>
    <script src="assets/js/app.js"></script>

    <!-- Wizard + l√≥gica de p√°gina -->
    <script data-init>
      // ====== WIZARD (Registro general) ======
      const form = document.getElementById("wizardForm");
      const sections = form
        ? [...document.querySelectorAll("#pane-general section[data-step]")]
        : [];
      const steps = form
        ? [...document.querySelectorAll("#pane-general .stepper .step")]
        : [];

      // ----- Referencias para agente -----
      const agenteInput = document.getElementById("f-agente");
      const agenteInfo = document.getElementById("agente-info");
      const agenteError = document.getElementById("agente-error");

      // Cat√°logo temporal de agentes (simula la "base de datos")
      const CATALOGO_AGENTES = [
        { clave: "88200", nombre: "Agente 88200 Hylant" },
        { clave: "88201", nombre: "Agente 88201 Hylant 2" },
        { clave: "09005", nombre: "09005 Ventas Mostrador" },
      ];

      function buscarAgentePorClave(clave) {
        if (!clave) return null;
        return CATALOGO_AGENTES.find((a) => a.clave === clave) || null;
      }

      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnSave = document.getElementById("btnSave");
      const resume = document.getElementById("resume");
      let current = 1;

      // ====== Campos de horarios ======
      const fechaEnvioArea = form ? form.elements["fecha_envio_area"] : null;
      const horaEnvioArea = form ? form.elements["hora_envio_area"] : null;
      const fechaEnvioAgente = form
        ? form.elements["fecha_envio_agente"]
        : null;
      const horaEnvioAgente = form ? form.elements["hora_envio_agente"] : null;

      const errorHoraEnvioArea = document.getElementById(
        "error-hora-envio-area"
      );
      const errorHoraEnvioAgente = document.getElementById(
        "error-hora-envio-agente"
      );

      // ====== Horario laboral: lunes a viernes 08:30 a 18:30 ======
      function esHorarioLaboral(fechaStr, horaStr) {
        if (!fechaStr || !horaStr) return true;
        const dt = new Date(`${fechaStr}T${horaStr}`);
        if (Number.isNaN(dt.getTime())) return true;
        const day = dt.getDay(); // 0 = domingo, 6 = s√°bado
        if (day === 0 || day === 6) return false;
        const minutes = dt.getHours() * 60 + dt.getMinutes();
        const start = 8 * 60 + 30; // 08:30
        const end = 18 * 60 + 30; // 18:30
        return minutes >= start && minutes <= end;
      }

      function validarHoraEnvioArea() {
        if (!horaEnvioArea || !fechaEnvioArea) return true;
        const f = fechaEnvioArea.value;
        const h = horaEnvioArea.value;

        if (!f || !h) {
          horaEnvioArea.classList.remove("is-invalid");
          if (errorHoraEnvioArea) errorHoraEnvioArea.textContent = "";
          return true;
        }

        const ok = esHorarioLaboral(f, h);
        if (!ok) {
          horaEnvioArea.classList.add("is-invalid");
          if (errorHoraEnvioArea) {
            errorHoraEnvioArea.textContent =
              "Debe estar en horario laboral: lunes a viernes de 08:30 a 18:30.";
          }
        } else {
          horaEnvioArea.classList.remove("is-invalid");
          if (errorHoraEnvioArea) errorHoraEnvioArea.textContent = "";
        }
        return ok;
      }

      function validarHoraEnvioAgente() {
        if (!horaEnvioAgente || !fechaEnvioAgente) return true;
        const f = fechaEnvioAgente.value;
        const h = horaEnvioAgente.value;

        if (!f || !h) {
          horaEnvioAgente.classList.remove("is-invalid");
          if (errorHoraEnvioAgente) errorHoraEnvioAgente.textContent = "";
          return true;
        }

        const ok = esHorarioLaboral(f, h);
        if (!ok) {
          horaEnvioAgente.classList.add("is-invalid");
          if (errorHoraEnvioAgente) {
            errorHoraEnvioAgente.textContent =
              "Debe estar en horario laboral: lunes a viernes de 08:30 a 18:30.";
          }
        } else {
          horaEnvioAgente.classList.remove("is-invalid");
          if (errorHoraEnvioAgente) errorHoraEnvioAgente.textContent = "";
        }
        return ok;
      }

      // Autollenar colaborador + fecha/hora recepci√≥n
      // --- Funci√≥n para autollenar colaborador + fecha/hora con el usuario logueado ---
      function initCabecera() {
        const usuarioStr = localStorage.getItem("hd_usuario");
        // üëá Todos los inputs "colaborador" (Registro general + Renovaciones)
        const colabInputs = document.querySelectorAll(
          'input[name="colaborador"]'
        );
        const fechaInput = document.getElementById("f-fecha");
        const horaRecInput = document.getElementById("f-hrec");

        // Colaborador desde el login
        if (usuarioStr && colabInputs.length) {
          try {
            const u = JSON.parse(usuarioStr);
            const nombre = u.nombre || u.username || "";
            if (nombre) {
              colabInputs.forEach((input) => {
                input.value = nombre;
                input.readOnly = true;
                input.classList.add("bg-light", "text-muted");
              });
            }
          } catch (e) {
            console.error("No se pudo parsear hd_usuario", e);
          }
        }

        // Fecha y hora de recepci√≥n por defecto = ahora (solo aplica al wizard)
        const now = new Date();
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = now.getFullYear();
        const mm = pad(now.getMonth() + 1);
        const dd = pad(now.getDate());
        const hh = pad(now.getHours());
        const mi = pad(now.getMinutes());
        const fechaHoy = `${yyyy}-${mm}-${dd}`;
        const horaAhora = `${hh}:${mi}`;

        if (fechaInput) {
          fechaInput.value = fechaHoy;
        }
        if (horaRecInput) {
          horaRecInput.value = horaAhora;
        }
      }

      // Autollenar env√≠o al agente al entrar al paso 3 (si est√°n vac√≠os)
      function autoFillEnvioAgenteAlEntrar() {
        if (!fechaEnvioAgente || !horaEnvioAgente) return;

        const now = new Date();
        const pad = (n) => String(n).padStart(2, "0");

        const yyyy = now.getFullYear();
        const mm = pad(now.getMonth() + 1);
        const dd = pad(now.getDate());
        const hh = pad(now.getHours());
        const mi = pad(now.getMinutes());

        const fechaHoy = `${yyyy}-${mm}-${dd}`;
        const horaAhora = `${hh}:${mi}`;

        if (!fechaEnvioAgente.value) {
          fechaEnvioAgente.value = fechaHoy;
        }
        if (!horaEnvioAgente.value) {
          horaEnvioAgente.value = horaAhora;
        }

        validarHoraEnvioAgente();
      }

      initCabecera();

      function limpiarErroresAgente() {
        if (agenteInput) agenteInput.classList.remove("is-invalid");
        if (agenteError) agenteError.textContent = "";
      }

      // Forzar siempre 5 d√≠gitos en la captura
      if (agenteInput) {
        agenteInput.addEventListener("input", (e) => {
          let v = e.target.value || "";
          v = v.replace(/\D/g, "");
          if (v.length > 5) v = v.slice(0, 5);
          e.target.value = v;
          limpiarErroresAgente();
          if (v.length < 5 && agenteInfo) {
            agenteInfo.textContent = "";
          }
        });

        agenteInput.addEventListener("blur", () => {
          const v = agenteInput.value.trim();
          if (!v) return;

          if (!/^\d{5}$/.test(v)) {
            agenteInput.classList.add("is-invalid");
            if (agenteError) {
              agenteError.textContent =
                "La clave del agente debe tener exactamente 5 d√≠gitos.";
            }
            if (agenteInfo) agenteInfo.textContent = "";
            return;
          }

          const agente = buscarAgentePorClave(v);
          if (!agente) {
            agenteInput.classList.add("is-invalid");
            if (agenteError) {
              agenteError.textContent =
                "No se encontr√≥ un agente con esa clave.";
            }
            if (agenteInfo) agenteInfo.textContent = "";
            return;
          }

          limpiarErroresAgente();
          if (agenteInfo) {
            agenteInfo.textContent = `Agente: ${agente.nombre}`;
          }
        });
      }

      function lastStep() {
        return sections.length ? +sections.at(-1).dataset.step : 1;
      }

      function focusFirstInput(stepEl) {
        const el =
          stepEl && stepEl.querySelector("input, select, textarea, button");
        if (el) el.focus({ preventScroll: true });
      }

      function showStep(n) {
        if (!form) return;
        const last = lastStep();
        current = Math.max(1, Math.min(n, last));

        sections.forEach((s) =>
          s.classList.toggle("d-none", +s.dataset.step !== current)
        );
        steps.forEach((s) => {
          s.classList.toggle("active", +s.dataset.step === current);
          s.classList.toggle("done", +s.dataset.step < current);
        });

        btnPrev.disabled = current === 1;
        btnNext.classList.toggle("d-none", current === last);
        btnSubmit.classList.toggle("d-none", current !== last);

        if (current === 4) {
          buildResume();
        }

        // Al entrar al paso 3 (Env√≠o al Agente) autollenamos fecha/hora si est√°n vac√≠os
        if (current === 3) {
          autoFillEnvioAgenteAlEntrar();
        }

        focusFirstInput(sections.find((s) => +s.dataset.step === current));
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function buildResume() {
        const data = Object.fromEntries(new FormData(form));
        const pretty = {
          colaborador: "Colaborador",
          fecha: "Fecha",
          hora_recepcion: "Hora de recepci√≥n",
          agente_clave: "Agente clave",
          forma_solicitud: "Forma de solicitud",
          tipo_solicitud: "Tipo de solicitud",
          enviado_area: "Enviado al √°rea",
          fecha_envio_area: "Fecha env√≠o √°rea",
          hora_envio_area: "Hora env√≠o √°rea",
          fecha_resp_area: "Fecha respuesta √°rea",
          hora_resp_area: "Hora respuesta √°rea",
          fecha_envio_agente: "Fecha env√≠o agente",
          hora_envio_agente: "Hora env√≠o agente",
          estatus: "Estatus",
          fecha_seguimiento: "Fecha seguimiento",
          comentarios: "Comentarios",
        };
        resume.innerHTML = Object.entries(pretty)
          .map(([key, label]) => {
            const val = (data[key] ?? "") || "‚Äî";
            return `<div class="col-md-4"><div class="border rounded-3 p-3 bg-light mb-2"><div class="text-muted">${label}</div><div class="fw-semibold">${val}</div></div></div>`;
          })
          .join("");
      }

      function validateStep() {
        let ok = true;
        const visible = sections.find((s) => +s.dataset.step === current);
        if (!visible) return true;

        [...visible.querySelectorAll("[required]")].forEach((inp) => {
          const name = inp.name;

          if (!inp.value) {
            inp.classList.add("is-invalid");
            ok = false;
          } else {
            inp.classList.remove("is-invalid");
          }

          if (name === "agente_clave" && inp.value) {
            const v = inp.value.trim();
            if (!/^\d{5}$/.test(v)) {
              inp.classList.add("is-invalid");
              ok = false;
              if (agenteInfo) {
                agenteInfo.textContent =
                  "La clave del agente debe tener exactamente 5 d√≠gitos.";
              }
            }
          }

          inp.addEventListener(
            "input",
            () => inp.classList.remove("is-invalid"),
            { once: true }
          );
        });

        if (current === 3) {
          ok = validarHoraEnvioArea() && validarHoraEnvioAgente() && ok;
        }

        return ok;
      }

      function debounce(fn, ms = 400) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      function saveDraft(showToast) {
        const data = Object.fromEntries(new FormData(form));
        localStorage.setItem(
          "helpdesk_draft",
          JSON.stringify({ current, data, when: Date.now() })
        );
        if (showToast && window.bootstrap) {
          const t = document.createElement("div");
          t.className =
            "toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3";
          t.role = "alert";
          t.innerHTML = `<div class="d-flex"><div class="toast-body">Borrador guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
          document.body.appendChild(t);
          const toast = new bootstrap.Toast(t);
          toast.show();
          t.addEventListener("hidden.bs.toast", () => t.remove());
        }
      }

      const saveDraftDebounced = debounce(() => saveDraft(false), 500);

      function parseDT(d, t) {
        if (!d || !t) return null;
        return new Date(`${d}T${t}`);
      }

      function humanDiff(ms) {
        if (!Number.isFinite(ms)) return "‚Äî";
        const min = Math.round(ms / 60000);
        const h = Math.floor(min / 60);
        const m = min % 60;
        if (h <= 0) return `${m} min`;
        if (m === 0) return `${h} h`;
        return `${h} h ${m} min`;
      }

      function computeDurations() {
        const dRec = form.fecha?.value,
          tRec = form.hora_recepcion?.value;
        const dEnvA = form.fecha_envio_area?.value,
          tEnvA = form.hora_envio_area?.value;
        const dResp = form.fecha_resp_area?.value,
          tResp = form.hora_resp_area?.value;

        const dtRec = parseDT(dRec, tRec);
        const dtEnvA = parseDT(dEnvA, tEnvA);
        const dtResp = parseDT(dResp, tResp);

        const chipEnv = document.getElementById("chip_t_envio_area");
        const chipEnvVal = chipEnv?.querySelector('[data-val="t_envio"]');
        if (dtRec && dtEnvA && chipEnv && chipEnvVal) {
          chipEnv.hidden = false;
          chipEnvVal.textContent = humanDiff(dtEnvA - dtRec);
        } else if (chipEnv) {
          chipEnv.hidden = true;
        }

        const chipResp = document.getElementById("chip_t_resp_area");
        const chipRespVal = chipResp?.querySelector('[data-val="t_resp"]');
        if (dtEnvA && dtResp && chipResp && chipRespVal) {
          chipResp.hidden = false;
          chipRespVal.textContent = humanDiff(dtResp - dtEnvA);
        } else if (chipResp) {
          chipResp.hidden = true;
        }
      }

      if (form) {
        if (fechaEnvioArea)
          fechaEnvioArea.addEventListener("change", validarHoraEnvioArea);
        if (horaEnvioArea)
          horaEnvioArea.addEventListener("change", validarHoraEnvioArea);
        if (fechaEnvioAgente)
          fechaEnvioAgente.addEventListener("change", validarHoraEnvioAgente);
        if (horaEnvioAgente)
          horaEnvioAgente.addEventListener("change", validarHoraEnvioAgente);

        btnNext.addEventListener("click", () => {
          if (validateStep()) {
            current = Math.min(current + 1, lastStep());
            showStep(current);
            saveDraft();
          }
        });

        btnPrev.addEventListener("click", () => {
          current = Math.max(1, current - 1);
          showStep(current);
        });

        btnSave.addEventListener("click", () => saveDraft(true));

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          if (!validateStep()) {
            return;
          }

          const fd = new FormData(form);
          const data = Object.fromEntries(fd.entries());

          const usuarioStr = localStorage.getItem("hd_usuario");
          if (usuarioStr) {
            try {
              const u = JSON.parse(usuarioStr);
              data.usuario_login = u.username || null;
              data.usuario_nombre = u.nombre || null;
              data.usuario_rol = u.rol || null;
            } catch (e) {
              console.error("No se pudo leer hd_usuario", e);
            }
          }

          console.log("Payload listo para /api/actividades:", data);
          alert(
            "Registro preparado para enviar (mock). Revisa la consola para ver el JSON que se mandar√≠a."
          );

          localStorage.removeItem("helpdesk_draft");
          form.reset();
          current = 1;
          showStep(current);
          initCabecera();
        });

        form.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const target = e.target;
          if (!target || !(target instanceof HTMLElement)) return;
          const isTextArea = target.tagName === "TEXTAREA";

          if (isTextArea && !e.shiftKey) {
            return;
          }

          e.preventDefault();

          const currentSection = sections.find(
            (s) => +s.dataset.step === current
          );
          if (!currentSection) return;

          const focusables = Array.from(
            currentSection.querySelectorAll("input, select, textarea, button")
          ).filter((el) => {
            if (!(el instanceof HTMLElement)) return false;
            if (el.disabled) return false;
            if (el.type === "hidden") return false;
            return el.offsetParent !== null;
          });

          const idx = focusables.indexOf(target);

          // Enter especial para Agente Clave
          if (target === agenteInput && !e.shiftKey) {
            const clave = agenteInput.value.trim();
            if (!/^\d{5}$/.test(clave)) {
              agenteInput.classList.add("is-invalid");
              if (agenteError) {
                agenteError.textContent =
                  "La clave del agente debe tener exactamente 5 d√≠gitos.";
              }
              if (agenteInfo) agenteInfo.textContent = "";
              return;
            }
            const agente = buscarAgentePorClave(clave);
            if (!agente) {
              agenteInput.classList.add("is-invalid");
              if (agenteError) {
                agenteError.textContent =
                  "No se encontr√≥ un agente con esa clave.";
              }
              if (agenteInfo) agenteInfo.textContent = "";
              return;
            }
            limpiarErroresAgente();
            if (agenteInfo) {
              agenteInfo.textContent = `Agente: ${agente.nombre}`;
            }
            if (idx > -1 && idx < focusables.length - 1) {
              focusables[idx + 1].focus();
            }
            return;
          }

          if (e.shiftKey) {
            if (idx > 0) {
              focusables[idx - 1].focus();
            } else {
              if (current > 1) {
                current = current - 1;
                showStep(current);
              }
            }
            return;
          }

          if (idx > -1 && idx < focusables.length - 1) {
            focusables[idx + 1].focus();
          } else {
            if (validateStep()) {
              current = Math.min(current + 1, lastStep());
              showStep(current);
            }
          }
        });

        [
          "fecha",
          "hora_recepcion",
          "fecha_envio_area",
          "hora_envio_area",
          "fecha_resp_area",
          "hora_resp_area",
        ].forEach((name) => {
          if (form.elements[name])
            form.elements[name].addEventListener("input", computeDurations);
        });

        (function () {
          const draft = JSON.parse(
            localStorage.getItem("helpdesk_draft") || "null"
          );
          if (draft) {
            current = draft.current || 1;
            for (const [k, v] of Object.entries(draft.data || {})) {
              const el = form.elements[k];
              if (el) el.value = v;
            }
          }
          showStep(current);
          computeDurations();
        })();
      }

      // ====== RENOVACIONES (form espec√≠fico) ======
      const renForm = document.getElementById("renewForm");
      const renFecha = document.getElementById("ren_fecha");
      const renPolizaNueva = document.getElementById("ren_poliza_nueva");
      const renPolizaAnterior = document.getElementById("ren_poliza_anterior");
      const renSaveBtn = document.getElementById("renSave");

      function setNowIfEmpty() {
        if (!renFecha || renFecha.value) return;
      }

      if (renForm) {
        function maybeSetNow() {
          if (!renFecha.value) {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, "0");
            renFecha.value = `${now.getFullYear()}-${pad(
              now.getMonth() + 1
            )}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(
              now.getMinutes()
            )}`;
          }
        }

        renPolizaNueva.addEventListener("input", maybeSetNow);
        renPolizaAnterior.addEventListener("input", maybeSetNow);

        renSaveBtn.addEventListener("click", () => {
          const data = Object.fromEntries(new FormData(renForm));
          localStorage.setItem("helpdesk_renov_draft", JSON.stringify(data));
          if (window.bootstrap) {
            const t = document.createElement("div");
            t.className =
              "toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3";
            t.role = "alert";
            t.innerHTML = `<div class="d-flex"><div class="toast-body">Borrador de renovaci√≥n guardado</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
            document.body.appendChild(t);
            const toast = new bootstrap.Toast(t);
            toast.show();
            t.addEventListener("hidden.bs.toast", () => t.remove());
          }
        });

        renForm.addEventListener("submit", (e) => {
          e.preventDefault();
          alert("Renovaci√≥n registrada (mock). Aqu√≠ har√≠amos POST a /renewals");
          localStorage.removeItem("helpdesk_renov_draft");
          renForm.reset();
          if (renFecha) renFecha.value = "";
        });

        (function () {
          const d = JSON.parse(
            localStorage.getItem("helpdesk_renov_draft") || "null"
          );
          if (d) {
            Object.entries(d).forEach(([k, v]) => {
              const el = renForm.elements[k];
              if (el) el.value = v;
            });
          }
        })();
      }
    </script>

    <!-- Router SPA -->
    <script>
      (function () {
        const supportsVT = "startViewTransition" in document;
        async function loadPartial(url) {
          const res = await fetch(url, { credentials: "same-origin" });
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const newMain = doc.querySelector(".app-main");
          const newTitle =
            doc.querySelector("title")?.textContent || document.title;
          return { newMain, newTitle, doc };
        }
        function setActiveLink(url) {
          const links = document.querySelectorAll(".sidebar a[data-spa]");
          links.forEach((a) => a.classList.toggle("active", a.href === url));
        }
        async function navigate(url, push = true) {
          const currentMain = document.querySelector(".app-main");
          const doSwap = async () => {
            const { newMain, newTitle, doc } = await loadPartial(url);
            if (!newMain) {
              location.href = url;
              return;
            } // fallback total
            currentMain.classList.add("is-leaving");
            await new Promise((r) => setTimeout(r, 120));
            currentMain.replaceWith(newMain);
            document.title = newTitle;
            newMain.classList.add("is-entering");
            requestAnimationFrame(() =>
              newMain.classList.add("app-main--ready")
            );
            setTimeout(
              () => newMain.classList.remove("is-entering", "app-main--ready"),
              180
            );
            if (window.bootstrap) {
              document
                .querySelectorAll('[data-bs-toggle="tooltip"]')
                .forEach((el) => new bootstrap.Tooltip(el));
            }
            setActiveLink(new URL(url, location.href).href);
            doc.querySelectorAll("script[data-init]").forEach((s) => {
              try {
                eval(s.textContent);
              } catch (e) {
                console.error(e);
              }
            });
          };
          if (supportsVT) {
            document.startViewTransition(doSwap);
          } else {
            await doSwap();
          }
          if (push) history.pushState({ spa: true }, "", url);
        }
        document.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-spa]");
          if (!a) return;
          const url = a.getAttribute("href");
          if (!url || url.startsWith("http") || url.startsWith("#")) return;
          e.preventDefault();
          navigate(url, true);
        });
        window.addEventListener("popstate", (e) => {
          if (e.state && e.state.spa) {
            navigate(location.href, false);
          } else location.reload();
        });
      })();
    </script>

    <!-- JS Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>


